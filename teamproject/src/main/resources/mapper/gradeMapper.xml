<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ksmart.mapper.GradeMapper">
	<select id="getCustomerList" resultType="Customer">
		SELECT
			customer_id AS customerId
		FROM
			customer
	</select>
	<select id="divideGrade" parameterType="String" resultType="String">
		SELECT
			IF(SUM(DC.contract_total_price)&gt;300000, '플래티넘 회원'
				,IF(SUM(DC.contract_total_price)&gt;100000, '골드 회원'
					,IF(SUM(DC.contract_total_price)&gt;50000, '실버 회원'
						, '브론즈 회원'))) AS g
			FROM
				doc_contract AS DC
			RIGHT JOIN
				customer AS C
				ON
				DC.customer_id = C.customer_id
			WHERE
				C.customer_id = #{customerId}
				AND
				DC.contract_date &gt; DATE(CONCAT(YEAR(NOW())-1,'-', MONTH(NOW()),'-', '1'))
			GROUP BY
				C.customer_id
	</select>
	<update id="updateGrade" parameterType="String">
		UPDATE
			customer
		 SET
		 	customer_class = #{grade}
		WHERE 
			customer_id = #{customerId}
	</update>
	<insert id="insertGradeRecord">
		INSERT INTO 
			grade_record
			(
			grade_name
			,grade_record_cnt
			,grade_record_month
			)
		SELECT 
			customer_class
			, COUNT(1)
			, DATE(NOW()) 
		FROM 
			customer
		GROUP BY
			customer_class
	</insert>
</mapper>