<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ksmart.mapper.DocBillMapper">
	<resultMap type="DocBill" id="docBillResultMap">
		<result property="billCode" column="bill_code"/>
		<result property="contractCode" column="contract_code"/>
		<result property="billExpectedDate" column="bill_expected_date"/>
		<result property="billDate" column="bill_date"/>
		<result property="billPayday" column="bill_payday"/>
		<result property="billPayNumber" column="bill_pay_number"/>
		<result property="deliveryAddress" column="delivery_address"/>
		<result property="deliveryDetailAddress" column="delivery_detail_address"/>
		<result property="contractTotalPrice" column="contract_total_price"/>
		<result property="customerName" column="customer_name"/>
		<result property="customerCall" column="customer_call"/>
		<result property="customerCompanyName" column="customer_company_name"/>
		<result property="goodsName" column="goods_name"/>
		<result property="setName" column="set_name"/>
		<result property="count" column="count"/>
		<result property="total" column="total"/>
		<result property="rentalFromDate" column="rental_from_date"/>
		<result property="rentalToDate" column="rental_to_date"/>
		<result property="staffName" column="staff_name"/>
	</resultMap>
	<select id="getBillLastCode" resultType="int">
		SELECT 
			CAST(SUBSTRING(bill_code, 5) AS DECIMAL) AS billCode 
		FROM 
			doc_bill 
		ORDER BY 
			billCode DESC 
		LIMIT 1
	</select>
	<select id="getBillPayNumber" resultType="int">
		SELECT 
			bill_pay_number
		FROM 
			doc_bill
		WHERE 
			contract_code = #{contractCode}
		ORDER BY 
			bill_pay_number DESC
		LIMIT 1
	</select>
	<insert id="insertBill" parameterType="DocBill">
		INSERT INTO 
			doc_bill
			(bill_code
			, contract_code
			, bill_expected_date
			, bill_date
			, bill_pay_number)
		VALUES 
			(
			CONCAT('bill',LPAD(#{billCode}, 5, 0))
			, #{contractCode}
			, NOW()
			, DATE_ADD(NOW(),INTERVAL 10 DAY)
			, #{billPayNumber}
			)
	</insert>
	<select id="getDocBillList" parameterType="int" resultMap="docBillResultMap">
		SELECT
			*
			,DC.contract_total_price
			,C.customer_name
			,C.customer_call
			,CC.customer_company_name
			,G.goods_name
			,PS.set_name
			,S.staff_name
			,COUNT(1) AS count
			,SUM(DC.contract_total_price) AS total
		FROM
			doc_bill AS DB
		INNER JOIN
			doc_contract AS DC
			ON
			DB.contract_code = DC.contract_code
		INNER JOIN
			customer AS C
			ON
			DC.customer_id = C.customer_id
		LEFT JOIN
			customer_company AS CC
			ON
			C.customer_id = CC.customer_id
		LEFT JOIN
			goods AS G
			ON
			DC.goods_code = G.goods_code
		LEFT JOIN
			price_set AS PS
			ON
			DC.set_code = PS.set_code
		LEFT JOIN
			staff AS S
			ON
			S.staff_code = DC.staff_code
		GROUP BY
			DB.bill_code
		ORDER BY
			DB.bill_expected_date DESC
		LIMIT ${firstClmn}, ${lastClmn}
	</select>
	<select id="getDocBillListCnt" resultType="int">
		SELECT 
			COUNT(SQ.CNT)
		FROM
		(
		SELECT
				COUNT(1) AS CNT
			FROM
				doc_bill AS DB
			INNER JOIN
				doc_contract AS DC
				ON
				DB.contract_code = DC.contract_code
			INNER JOIN
				customer AS C
				ON
				DC.customer_id = C.customer_id
			LEFT JOIN
				customer_company AS CC
				ON
				C.customer_id = CC.customer_id
			LEFT JOIN
				goods AS G
				ON
				DC.goods_code = G.goods_code
			LEFT JOIN
				price_set AS PS
				ON
				DC.set_code = PS.set_code
			GROUP BY
				DB.bill_code
		) AS SQ
	</select>
	<select id="getDocBillSearchList" parameterType="DocBill" resultMap="docBillResultMap">
		SELECT
			*
			,DC.contract_total_price
			,C.customer_name
			,C.customer_call
			,CC.customer_company_name
			,G.goods_name
			,PS.set_name
			,S.staff_name
			,COUNT(1) AS count
			,SUM(DC.contract_total_price) AS total
		FROM
			doc_bill AS DB
		INNER JOIN
			doc_contract AS DC
			ON
			DB.contract_code = DC.contract_code
		INNER JOIN
			customer AS C
			ON
			DC.customer_id = C.customer_id
		LEFT JOIN
			customer_company AS CC
			ON
			C.customer_id = CC.customer_id
		LEFT JOIN
			goods AS G
			ON
			DC.goods_code = G.goods_code
		LEFT JOIN
			price_set AS PS
			ON
			DC.set_code = PS.set_code
		LEFT JOIN
			staff AS S
			ON
			S.staff_code = DC.staff_code
		WHERE 
			TRUE
			<if test="customerName neq null and customerName neq ''.toString()">
				AND C.customer_name = #{customerName}
			</if>
			<if test="staffName neq null and staffName neq ''.toString()">
				AND S.staff_name = #{staffName}
			</if>
			<if test="customerCall neq null and customerCall neq ''.toString()">
				AND C.customer_call =#{customerCall}
			</if>
			<if test="setName neq null and setName neq ''.toString()">
				AND PS.set_name = #{setName}
			</if>
			<if test="goodsName neq null and goodsName neq ''.toString()">
				AND G.goods_name = #{goodsName}
			</if>
			<if test="rentalFromDate neq null and rentalFromDate neq ''.toString()">
				AND DC.rental_from_date &gt;= #{rentalFromDate}
			</if>
			<if test="rentalToDate neq null and rentalToDate neq ''.toString()">
				AND DC.rental_to_date &lt;= #{rentalToDate}
			</if>	
		GROUP BY
			DB.bill_code
		ORDER BY
			DB.bill_expected_date DESC
		LIMIT ${firstClmn}, ${lastClmn}
	</select>
	<select id="getDocBillSearchListCnt" parameterType="DocBill" resultType="int">
		SELECT 
			COUNT(SQ.CNT)
		FROM
		(
		SELECT
			COUNT(1) AS CNT
		FROM
			doc_bill AS DB
		INNER JOIN
			doc_contract AS DC
			ON
			DB.contract_code = DC.contract_code
		INNER JOIN
			customer AS C
			ON
			DC.customer_id = C.customer_id
		LEFT JOIN
			customer_company AS CC
			ON
			C.customer_id = CC.customer_id
		LEFT JOIN
			goods AS G
			ON
			DC.goods_code = G.goods_code
		LEFT JOIN
			price_set AS PS
			ON
			DC.set_code = PS.set_code
		LEFT JOIN
			staff AS S
			ON
			S.staff_code = DC.staff_code
		WHERE 
			TRUE
			<if test="customerName neq null and customerName neq ''.toString()">
				AND C.customer_name = #{customerName}
			</if>
			<if test="staffName neq null and staffName neq ''.toString()">
				AND S.staff_name = #{staffName}
			</if>
			<if test="customerCall neq null and customerCall neq ''.toString()">
				AND C.customer_call =#{customerCall}
			</if>
			<if test="setName neq null and setName neq ''.toString()">
				AND PS.set_name = #{setName}
			</if>
			<if test="goodsName neq null and goodsName neq ''.toString()">
				AND G.goods_name = #{goodsName}
			</if>
			<if test="rentalFromDate neq null and rentalFromDate neq ''.toString()">
				AND DC.rental_from_date &gt;= #{rentalFromDate}
			</if>
			<if test="rentalToDate neq null and rentalToDate neq ''.toString()">
				AND DC.rental_to_date &lt;= #{rentalToDate}
			</if>	
		GROUP BY
			DB.bill_code
		) AS SQ
	</select>
	<select id="getDocBillForm" resultMap="docBillResultMap">
		SELECT
			*
			,DC.contract_total_price
			,C.customer_name
			,C.customer_call
			,CC.customer_company_name
			,G.goods_name
			,PS.set_name
			,COUNT(1) AS count
			,SUM(DC.contract_total_price) AS total
		FROM
			doc_bill AS DB
		INNER JOIN
			doc_contract AS DC
			ON
			DB.contract_code = DC.contract_code
		INNER JOIN
			customer AS C
			ON
			DC.customer_id = C.customer_id
		LEFT JOIN
			customer_company AS CC
			ON
			C.customer_id = CC.customer_id
		LEFT JOIN
			goods AS G
			ON
			DC.goods_code = G.goods_code
		LEFT JOIN
			price_set AS PS
			ON
			DC.set_code = PS.set_code
		WHERE 
			DB.bill_code=#{billCode}
		GROUP BY
			DB.bill_code
	</select>
</mapper>